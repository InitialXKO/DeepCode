name: Linting and Formatting

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    lint-and-format:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
                fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                python-version: '3.x'

            - name: Install dependencies
              run: |
                python -m pip install --upgrade pip
                pip install pre-commit

            - name: Run pre-commit
              run: pre-commit run --all-files --show-diff-on-failure
              continue-on-error: true

            - name: Check for changes
              id: verify-changed-files
              run: |
                if git diff --quiet; then
                  echo "changed=false" >> $GITHUB_OUTPUT
                else
                  echo "changed=true" >> $GITHUB_OUTPUT
                fi

            - name: Commit and push changes
              if: steps.verify-changed-files.outputs.changed == 'true' && github.event_name == 'push'
              run: |
                git config --local user.email "github-actions[bot]@users.noreply.github.com"
                git config --local user.name "github-actions[bot]"
                git add -A
                git commit -m "style: auto-fix formatting issues from pre-commit"
                git push
